{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} - Modifier la sortie{% endblock %}

{% block body %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">
            Modifier la sortie : {{ sortie.nom }}
        </h1>

        {{ form_start(form, {'attr': {'class': 'space-y-8'}}) }}

        {# Mise en page : Grille 2 colonnes sur grand √©cran, 1 colonne sur mobile #}
        <div class="flex flex-col lg:flex-row lg:items-stretch gap-8">

            {# COLONNE GAUCHE : INFORMATIONS G√âN√âRALES #}
            <div class="bg-white shadow sm:rounded-lg border border-gray-200 lg:w-1/2 flex flex-col">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Informations g√©n√©rales
                    </h3>
                </div>

                <div class="p-6 space-y-6 flex-grow">
                    {# Champ : Nom de la sortie #}
                    <div>
                        {{ form_label(form.nom, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.nom, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.nom, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Champ : Date de d√©but #}
                    <div>
                        {{ form_label(form.dateHeureDebut, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.dateHeureDebut, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.dateHeureDebut, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Champ : Date limite d'inscription #}
                    <div>
                        {{ form_label(form.dateLimiteInscription, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.dateLimiteInscription, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.dateLimiteInscription, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Ligne double : Places et Dur√©e #}
                    <div class="grid grid-cols-2 gap-4">
                        {# Champ : Nombre de places max #}
                        <div>
                            {{ form_label(form.nbInscriptionsMax, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            {{ form_widget(form.nbInscriptionsMax, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                            {{ form_errors(form.nbInscriptionsMax, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                        </div>

                        {# Champ : Dur√©e en minutes #}
                        <div>
                            {{ form_label(form.duree, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <div class="relative mt-1">
                                {{ form_widget(form.duree, {'attr': {'class': 'block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pr-12'}}) }}
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">min</span>
                                </div>
                            </div>
                            {{ form_errors(form.duree, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                        </div>
                    </div>
                </div>
            </div>

            {# COLONNE DROITE : LOCALISATION (CAMPUS / VILLE / LIEU) #}
            <div class="bg-white shadow sm:rounded-lg border border-gray-200 lg:w-1/2 flex flex-col">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Localisation
                    </h3>
                </div>

                <div class="p-6 space-y-6 flex-grow">
                    {# Affichage du Campus de l'utilisateur (Champ d√©sactiv√©, lecture seule) #}
                    <div>
                        <label for="campus_display" class="block text-sm font-medium text-gray-700">Campus organisateur</label>
                        <input type="text" id="campus_display" disabled value="{{ app.user.campus.nom }}"
                               class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm text-gray-500 cursor-not-allowed sm:text-sm">
                    </div>

                    {# Champ : Ville (Sert √† filtrer les lieux si JS activ√©, ou simple info) #}
                    <div>
                        {{ form_label(form.ville, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.ville, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                    </div>

                    {# Champ : Lieu (S√©lection finale + Lien d'ajout visuel) #}
                    <div class="relative">
                        <div class="flex justify-between">
                            {{ form_label(form.lieu, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <button type="button" class="text-sm text-blue-600 hover:text-blue-500 font-medium hover:underline focus:outline-none">
                                + Ajouter un lieu
                            </button>
                        </div>
                        {{ form_widget(form.lieu, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.lieu, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Zone d'affichage des d√©tails (Rue/CP) - Cach√©e par d√©faut sans JS #}
                    <div id="lieu-details" class="bg-blue-50 p-4 rounded-md border border-blue-100 hidden">
                        <div class="space-y-2">
                            <p class="text-sm text-blue-800 flex justify-between">
                                <span class="font-bold">Rue :</span>
                                <span id="lieu-rue" class="font-normal">--</span>
                            </p>
                            <p class="text-sm text-blue-800 flex justify-between">
                                <span class="font-bold">Code postal :</span>
                                <span id="lieu-cp" class="font-normal">--</span>
                            </p>
                            {# S√©parateur #}
                            <div class="border-t border-blue-200 my-2"></div>

                            {# Latitude & Longitude #}
                            <div class="flex justify-between space-x-4">
                                <p class="text-sm text-blue-800">
                                    <span class="font-bold">Latitude :</span>
                                    <span id="lieu-latitude" class="font-mono text-xs">--</span>
                                </p>
                                <p class="text-sm text-blue-800">
                                    <span class="font-bold">Longitude :</span>
                                    <span id="lieu-longitude" class="font-mono text-xs">--</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Champ : Description / Infos #}
        <div class="mt-8 bg-white shadow sm:rounded-lg border border-gray-200 w-full">
            <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Description et informations compl√©mentaires
                </h3>
            </div>
            <div class="p-6">
                {{ form_label(form.infosSortie, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.infosSortie, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm', 'rows': 6}}) }}
                {{ form_errors(form.infosSortie, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
            </div>
        </div>

        {# --- BARRE D'ACTIONS --- #}
        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-8">

            {# --- GAUCHE : SUPPRIMER --- #}
            <div class="w-full sm:w-auto flex justify-center sm:justify-start">
                <a href="{{ path('app_sortie_supprimer', {'id': sortie.id}) }}"
                   class="inline-flex items-center px-4 py-2 border border-red-200 text-sm font-medium rounded-md text-red-600 bg-red-50 hover:bg-red-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                   onclick="return confirm('Attention : Cette action est irr√©versible.\n\nVoulez-vous vraiment supprimer ce brouillon ?');">
                    {# Ajout de l'ic√¥ne poubelle #}
                    <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Supprimer
                </a>
            </div>

            {# --- DROITE : ACTIONS DE FLUX --- #}
            <div class="flex flex-col sm:flex-row items-center gap-3">

                {# Annuler #}
                <a href="{{ path('app_accueil') }}"
                   class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors w-full sm:w-auto">                    Annuler
                </a>

                {# Enregistrer #}
                <button type="submit"
                        class="inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 w-full sm:w-auto">
                    <svg class="mr-2 h-4 w-4 text-violet-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    Enregistrer le brouillon
                </button>

                {# Publier #}
                <button type="submit" name="publier"
                        class="inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 w-full sm:w-auto">
                    <svg class="mr-2 h-4 w-4 text-blue-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                    Publier
                </button>
            </div>
        </div>

        {{ form_end(form) }}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        /*
         * GESTION DYNAMIQUE DU FORMULAIRE SORTIE
         * G√®re l'interd√©pendance Ville <-> Lieu et l'affichage des coordonn√©es.
         * Compatible avec le cycle de vie Symfony Turbo.
         */
        document.addEventListener('turbo:load', function() {

            // 1. CIBLAGE PR√âCIS DES √âL√âMENTS
            const villeSelect = document.getElementById('sortie_ville');
            const lieuSelect = document.getElementById('sortie_lieu');

            // √âl√©ments d'affichage (D√©tails)
            const lieuDetails = document.getElementById('lieu-details');

            // Si on n'est pas sur la page contenant le formulaire, on arr√™te.
            if (!villeSelect || !lieuSelect) return;

            // Protection : Emp√™che le script de se lancer 2 fois sur les m√™mes √©l√©ments
            if (villeSelect.dataset.jsAttached === "true") return;
            villeSelect.dataset.jsAttached = "true";

            console.log("üìç Initialisation du module Localisation...");

            // 2. FONCTION : CHARGER LES LIEUX DEPUIS L'API
            const chargerLieux = (villeId) => {
                // UX : On vide la liste et on d√©sactive le temps de charger
                lieuSelect.innerHTML = '<option value="">Chargement...</option>';
                lieuSelect.disabled = true;

                // On cache les d√©tails du lieu pr√©c√©dent
                if(lieuDetails) lieuDetails.classList.add('hidden');

                if (!villeId) {
                    lieuSelect.innerHTML = '<option value="">-- Choisir une ville d\'abord --</option>';
                    lieuSelect.disabled = false;
                    return;
                }

                // Appel API
                // On utilise un ID fictif '0' qu'on remplace par l'ID r√©el de la ville
                const url = "{{ path('app_api_lieux_ville', {'id': 0}) }}".replace('0', villeId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        lieuSelect.innerHTML = '<option value="">-- Choisir un lieu --</option>';

                        if (data.length > 0) {
                            data.forEach(lieu => {
                                // Cr√©ation propre des options
                                const option = new Option(lieu.nom, lieu.id);
                                lieuSelect.add(option);
                            });
                        } else {
                            lieuSelect.innerHTML = '<option value="">Aucun lieu pour cette ville</option>';
                        }
                    })
                    .catch(error => {
                        console.error("Erreur API :", error);
                        lieuSelect.innerHTML = '<option value="">Erreur de chargement</option>';
                    })
                    .finally(() => {
                        lieuSelect.disabled = false;
                    });
            };

            // 3. FONCTION : AFFICHER LES D√âTAILS (Rue, Lat, Long...)
            const afficherDetails = (lieuId) => {
                if (!lieuId) {
                    if(lieuDetails) lieuDetails.classList.add('hidden');
                    return;
                }

                const url = "{{ path('app_api_lieu_details', {'id': 0}) }}".replace('0', lieuId);

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if(lieuDetails) {
                            document.getElementById('lieu-rue').textContent = data.rue || 'Non renseign√©';
                            document.getElementById('lieu-cp').textContent = data.codePostal || 'Non renseign√©';
                            document.getElementById('lieu-latitude').textContent = data.latitude || '--';
                            document.getElementById('lieu-longitude').textContent = data.longitude || '--';

                            lieuDetails.classList.remove('hidden');
                        }
                    })
                    .catch(error => console.error("Erreur D√©tails :", error));
            };

            // 4. √âCOUTEURS D'√âV√âNEMENTS
            villeSelect.addEventListener('change', (e) => chargerLieux(e.target.value));
            lieuSelect.addEventListener('change', (e) => afficherDetails(e.target.value));

            // 5. INITIALISATION (Logique de d√©marrage)

            // Cas A : Mode "Modifier" (Un lieu est d√©j√† s√©lectionn√©)
            if (lieuSelect.value) {
                afficherDetails(lieuSelect.value);
            }
            // Cas B : Mode "Cr√©er" (Ville pr√©-remplie, mais pas de lieu)
            else if (villeSelect.value) {
                // IMPORTANT : C'est ici qu'on emp√™che l'affichage de "Tous les lieux"
                // On force le rechargement de la liste pour ne garder que ceux de la ville
                chargerLieux(villeSelect.value);
            }
            // Cas C : Rien n'est s√©lectionn√©
            else {
                // On vide la liste par s√©curit√©
                lieuSelect.innerHTML = '<option value="">-- Choisir une ville d\'abord --</option>';
            }
        });
    </script>
{% endblock %}
