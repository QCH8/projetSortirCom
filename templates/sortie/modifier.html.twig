{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} - Modifier la sortie{% endblock %}

{% block body %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-8 text-center">
            Modifier la sortie : {{ sortie.nom }}
        </h1>

        {{ form_start(form, {'attr': {'class': 'space-y-8'}}) }}

        {# Mise en page : Grille 2 colonnes sur grand écran, 1 colonne sur mobile #}
        <div class="flex flex-col lg:flex-row lg:items-stretch gap-8">

            {# COLONNE GAUCHE : INFORMATIONS GÉNÉRALES #}
            <div class="bg-white shadow sm:rounded-lg border border-gray-200 lg:w-1/2 flex flex-col">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Informations générales
                    </h3>
                </div>

                <div class="p-6 space-y-6 flex-grow">
                    {# Champ : Nom de la sortie #}
                    <div>
                        {{ form_label(form.nom, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.nom, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.nom, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Champ : Date de début #}
                    <div>
                        {{ form_label(form.dateHeureDebut, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.dateHeureDebut, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.dateHeureDebut, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Champ : Date limite d'inscription #}
                    <div>
                        {{ form_label(form.dateLimiteInscription, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.dateLimiteInscription, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.dateLimiteInscription, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Ligne double : Places et Durée #}
                    <div class="grid grid-cols-2 gap-4">
                        {# Champ : Nombre de places max #}
                        <div>
                            {{ form_label(form.nbInscriptionsMax, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            {{ form_widget(form.nbInscriptionsMax, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                            {{ form_errors(form.nbInscriptionsMax, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                        </div>

                        {# Champ : Durée en minutes #}
                        <div>
                            {{ form_label(form.duree, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <div class="relative mt-1">
                                {{ form_widget(form.duree, {'attr': {'class': 'block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pr-12'}}) }}
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">min</span>
                                </div>
                            </div>
                            {{ form_errors(form.duree, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                        </div>
                    </div>
                </div>
            </div>

            {# COLONNE DROITE : LOCALISATION (CAMPUS / VILLE / LIEU) #}
            <div class="bg-white shadow sm:rounded-lg border border-gray-200 lg:w-1/2 flex flex-col">
                <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        Localisation
                    </h3>
                </div>

                <div class="p-6 space-y-6 flex-grow">
                    {# Affichage du Campus de l'utilisateur (Champ désactivé, lecture seule) #}
                    <div>
                        <label for="campus_display" class="block text-sm font-medium text-gray-700">Campus organisateur</label>
                        <input type="text" id="campus_display" disabled value="{{ app.user.campus.nom }}"
                               class="mt-1 block w-full bg-gray-100 border-gray-300 rounded-md shadow-sm text-gray-500 cursor-not-allowed sm:text-sm">
                    </div>

                    {# Champ : Ville (Sert à filtrer les lieux si JS activé, ou simple info) #}
                    <div>
                        {{ form_label(form.ville, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                        {{ form_widget(form.ville, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                    </div>

                    {# Champ : Lieu (Sélection finale + Lien d'ajout visuel) #}
                    <div class="relative">
                        <div class="flex justify-between">
                            {{ form_label(form.lieu, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                            <button type="button" class="text-sm text-blue-600 hover:text-blue-500 font-medium hover:underline focus:outline-none">
                                + Ajouter un lieu
                            </button>
                        </div>
                        {{ form_widget(form.lieu, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm'}}) }}
                        {{ form_errors(form.lieu, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
                    </div>

                    {# Zone d'affichage des détails (Rue/CP) - Cachée par défaut sans JS #}
                    <div id="lieu-details" class="bg-blue-50 p-4 rounded-md border border-blue-100 hidden">
                        <div class="space-y-2">
                            <p class="text-sm text-blue-800 flex justify-between">
                                <span class="font-bold">Rue :</span>
                                <span id="lieu-rue" class="font-normal">--</span>
                            </p>
                            <p class="text-sm text-blue-800 flex justify-between">
                                <span class="font-bold">Code postal :</span>
                                <span id="lieu-cp" class="font-normal">--</span>
                            </p>
                            {# Séparateur #}
                            <div class="border-t border-blue-200 my-2"></div>

                            {# Latitude & Longitude #}
                            <div class="flex justify-between space-x-4">
                                <p class="text-sm text-blue-800">
                                    <span class="font-bold">Latitude :</span>
                                    <span id="lieu-latitude" class="font-mono text-xs">--</span>
                                </p>
                                <p class="text-sm text-blue-800">
                                    <span class="font-bold">Longitude :</span>
                                    <span id="lieu-longitude" class="font-mono text-xs">--</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Champ : Description / Infos #}
        <div class="mt-8 bg-white shadow sm:rounded-lg border border-gray-200 w-full">
            <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Description et informations complémentaires
                </h3>
            </div>
            <div class="p-6">
                {{ form_label(form.infosSortie, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.infosSortie, {'attr': {'class': 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm', 'rows': 6}}) }}
                {{ form_errors(form.infosSortie, {'attr': {'class': 'text-red-600 text-sm mt-1'}}) }}
            </div>
        </div>

        {# --- BARRE D'ACTIONS --- #}
        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row justify-center items-center gap-8">

            {# --- GAUCHE : SUPPRIMER --- #}
            <div class="w-full sm:w-auto flex justify-center sm:justify-start">
                <a href="{{ path('app_sortie_supprimer', {'id': sortie.id}) }}"
                   class="inline-flex items-center px-4 py-2 border border-red-200 text-sm font-medium rounded-md text-red-600 bg-red-50 hover:bg-red-100 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                   onclick="return confirm('Attention : Cette action est irréversible.\n\nVoulez-vous vraiment supprimer ce brouillon ?');">
                    {# Ajout de l'icône poubelle #}
                    <svg class="mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Supprimer
                </a>
            </div>

            {# --- DROITE : ACTIONS DE FLUX --- #}
            <div class="flex flex-col sm:flex-row items-center gap-3">

                {# Annuler #}
                <a href="{{ path('app_accueil') }}"
                   class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors w-full sm:w-auto">                    Annuler
                </a>

                {# Enregistrer #}
                <button type="submit"
                        class="inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-full sm:w-auto">
                    <svg class="mr-2 h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    Enregistrer le brouillon
                </button>

                {# Publier #}
                <button type="submit" name="publier"
                        class="inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 w-full sm:w-auto">
                    <svg class="mr-2 h-4 w-4 text-blue-100" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                    Publier
                </button>
            </div>
        </div>

        {{ form_end(form) }}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function initLocalisationScript() {
            // 1. SÉLECTION DES ÉLÉMENTS
            const villeSelect = document.querySelector('[id$="_ville"]');
            const lieuSelect = document.querySelector('[id$="_lieu"]');
            const detailsBloc = document.getElementById('lieu-details');

            // Si les champs ne sont pas là (ex: autre page), on arrête
            if (!villeSelect || !lieuSelect) return;

            // 2. FONCTION D'AFFICHAGE
            const updateLieuDetails = (id) => {
                if (!id) {
                    detailsBloc.classList.add('hidden');
                    return;
                }

                // Petit effet visuel pour dire "je charge" (optionnel)
                detailsBloc.classList.remove('hidden');

                fetch(`/lieu/api/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('lieu-rue').textContent = data.rue || '--';
                        document.getElementById('lieu-cp').textContent = data.codePostal || '--';
                        document.getElementById('lieu-latitude').textContent = data.latitude || '--';
                        document.getElementById('lieu-longitude').textContent = data.longitude || '--';
                    })
                    .catch(err => console.error("Erreur API:", err));
            };

            // 3. LISTENERS
            // Changement de ville
            villeSelect.addEventListener('change', (e) => {
                lieuSelect.innerHTML = '<option value="">Chargement...</option>';
                fetch(`/ville/api/${e.target.value}/lieux`)
                    .then(r => r.json())
                    .then(data => {
                        lieuSelect.innerHTML = '<option value="">-- Choisir un lieu --</option>';
                        data.forEach(l => {
                            const opt = document.createElement('option');
                            opt.value = l.id;
                            opt.textContent = l.nom;
                            lieuSelect.appendChild(opt);
                        });
                        detailsBloc.classList.add('hidden');
                    });
            });

            // Changement de lieu
            lieuSelect.addEventListener('change', (e) => updateLieuDetails(e.target.value));

            // 4. INITIALISATION FORCÉE
            // On vérifie si une valeur est déjà là au chargement
            if (lieuSelect.value) {
                updateLieuDetails(lieuSelect.value);
            }
        }

        // 5. DÉCLENCHEURS
        // Cas 1 : Chargement classique (F5, Entrée dans l'URL)
        document.addEventListener('DOMContentLoaded', initLocalisationScript);

        // Cas 2 : Navigation via Symfony Turbo (Clic sur un lien "Modifier")
        document.addEventListener('turbo:load', initLocalisationScript);
    </script>
{% endblock %}
