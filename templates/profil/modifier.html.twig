{% extends 'base.html.twig' %}

{% block title %}Mon Profil{% endblock %}

{% block body %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    {# On ouvre le formulaire pour englober TOUT le contenu #}
    {{ form_start(form) }}
    
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-20 items-start">
        
        {# --- COLONNE GAUCHE : PHOTO + SUPPRESSION --- #}
        <div class="w-full md:w-64 flex-shrink-0 mt-32">
            <div id="preview-container" class="border-2 border-black p-1 bg-white shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                {% if app.user.photo %}
                    <img id="photo-preview" src="{{ asset('uploads/photos/' ~ app.user.photo) }}" class="w-full h-auto object-cover">
                {% else %}
                    <div id="photo-placeholder" class="w-full aspect-[4/3] bg-gray-50 flex items-center justify-center text-6xl">üë§</div>
                    <img id="photo-preview" src="" class="w-full h-auto object-cover hidden">
                {% endif %}
            </div>
            
            {# LA CORRECTION : On g√®re l'affichage ET le rendu pour Symfony #}
            {% if app.user.photo %}
                <div class="mt-4 flex items-center justify-start gap-2 text-red-600 font-bold text-sm">
                    {{ form_widget(form.delete_photo) }}
                    {{ form_label(form.delete_photo) }}
                </div>
            {% else %}
                {# Bonne pratique 2026 : On marque le champ comme "rendu" m√™me s'il est cach√© #}
                {% do form.delete_photo.setRendered() %}
            {% endif %}
        </div>

        {# --- COLONNE DROITE : FORMULAIRE --- #}
        <div class="flex-1">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-10 text-center md:text-left">Mon profil</h1>

            <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200 p-8 space-y-8">
                
                {# Section Infos G√©n√©rales #}
                <div>
                    <h2 class="text-lg font-bold text-indigo-600 uppercase mb-4 border-b border-indigo-100 pb-2">Informations personnelles</h2>
                    <div class="space-y-5">
                        <div class="flex flex-col gap-2">
                            <label class="font-bold text-gray-700">Ma photo</label>
                            <div class="flex items-center gap-4">
                                <label for="{{ form.photo.vars.id }}" class="cursor-pointer bg-black text-white px-6 py-2 font-bold hover:bg-gray-800 text-sm uppercase tracking-widest">
                                    Choisir un fichier
                                </label>
                                <span id="file-name" class="text-xs text-gray-400 italic">Aucun fichier s√©lectionn√©</span>
                                <div class="hidden">{{ form_widget(form.photo) }}</div>
                            </div>
                        </div>

                        {# On remplace form_row(form.pseudo) par ceci #}
                        {# Composant G√©n√©rique pour le PSEUDO #}
                        {{ component('UniqueFieldChecker', { 
                            value: form.pseudo.vars.value|default(''), 
                            fieldName: 'pseudo',
                            label: 'Pseudo',
                            errorMessage: 'Ce pseudo est d√©j√† pris.',
                            inputName: form.pseudo.vars.full_name,
                            initialValue: originalPseudo
                        }) }}
                        
                        {% do form.pseudo.setRendered() %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {{ form_row(form.prenom) }}
                            {{ form_row(form.nom) }}
                        </div>
                        {{ form_row(form.telephone) }}
                        
                        {# Composant G√©n√©rique pour l'EMAIL #}
                        {{ component('UniqueFieldChecker', { 
                            value: form.mail.vars.value|default(''), 
                            fieldName: 'mail',
                            label: 'Email',
                            errorMessage: 'Cet email est d√©j√† associ√© √† un compte.',
                            inputName: form.mail.vars.full_name,
                            initialValue: originalMail
                        }) }}
                        
                        {% do form.mail.setRendered() %}
                    </div>
                </div>

                {# Section S√©curit√© #}
                <div>
                    <h2 class="text-lg font-bold text-gray-800 uppercase mb-4">S√©curit√©</h2>
                    {{ form_row(form.password) }}
                </div>

                {# Section Campus #}
                <div>
                    <h2 class="text-lg font-bold text-indigo-600 uppercase mb-4 border-b border-indigo-100 pb-2">Rattachement</h2>
                    {{ form_row(form.campus) }}
                </div>

            </div>

            {# Bouton Enregistrer en bas √† droite #}
            <div class="mt-10 flex justify-center">
                <button type="submit" class="px-12 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-all">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    {{ form_end(form) }}
</div>

<script>
    document.getElementById('{{ form.photo.vars.id }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const fileNameSpan = document.getElementById('file-name');
        const previewImg = document.getElementById('photo-preview');
        const placeholder = document.getElementById('photo-placeholder');

        if (file) {
            fileNameSpan.textContent = file.name;
            const objectUrl = URL.createObjectURL(file);
            previewImg.src = objectUrl;
            previewImg.classList.remove('hidden');
            if (placeholder) placeholder.classList.add('hidden');
            previewImg.onload = () => URL.revokeObjectURL(objectUrl);
        }
    });
</script>
{% endblock %}